version: "3.9"
services:
  postgres:
    image: postgres:16
    environment:
      POSTGRES_USER: novastream
      POSTGRES_PASSWORD: novastream
      POSTGRES_DB: novastream
    ports: ["5432:5432"]
    volumes: [pg:/var/lib/postgresql/data]

  redis:
    image: redis:7
    ports: ["6379:6379"]

  minio:
    image: minio/minio:latest
    container_name: iptv-saas-minio
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=admin
      - MINIO_ROOT_PASSWORD=changeme123
    volumes:
      - minio_data:/data        # <- nouveau chemin
    ports:
      - "9000:9000"             # API S3
      - "9001:9001"             # Console
    restart: unless-stopped


  xtream-mock:
    build: ./services/xtream-mock
    ports: ["8888:8888"]

  api:
    build: ./packages/api
    depends_on: [postgres, redis, xtream-mock]
    ports: ["3000:3000"]
    environment:
      API_PORT: "3000"
      JWT_SECRET: "dev_jwt_secret"
      JWT_REFRESH_SECRET: "dev_refresh_secret"
      DATABASE_URL: "postgresql://novastream:novastream@postgres:5432/novastream"
      REDIS_URL: "redis://redis:6379"
      S3_ENDPOINT: "http://minio:9000"
      S3_ACCESS_KEY: "minio"
      S3_SECRET_KEY: "minio123"
      S3_BUCKET: "novastream"
      TMDB_API_KEY: "CHANGE_ME"
      XTREAM_BASE_URL: "http://xtream-mock:8888"

  web:
    build: ./packages/web
    depends_on: [api]
    ports: ["5173:5173"]
    environment:
      VITE_API_BASE: "http://85.31.239.110:3000"   # <- remplace localhost


volumes:
  pg:
